<!DOCTYPE html>
<body style="background: black; margin: 0">
  <canvas
    width="1280"
    height="800"
    style="
      display: block;
      margin: auto;
      height: min(calc(100vw * 800 / 1280), 100vh);
      width: min(calc(100vh * 1280 / 800), 100vw);
    "
  ></canvas>
  <script type="module">
    import { compile } from "./Compiler.js";
    import { run } from "./CPU.js";
    run(
      compile(`
        (INIT HAS_INPUT 0x7ffff0)
        (INIT INPUT_X 0x7ffff1)
        (INIT INPUT_Y 0x7ffff2)

        (INIT x 0xffffffff)
        (INIT y 0xffffffff)

        (FUNC main ()
          (INIT c 64)
          (INIT d 8)
          (INIT w 1)
          (WHILE 1
            (IF *HAS_INPUT 
              ((IF (&& (> x 0) (> y 0))
                  ((SET w (+ 1
                    (/ 
                      (+ 
                        (abs (- *INPUT_X x))
                        (abs (- *INPUT_Y y)))
                    5))))
                  (0))
                (SET c (+ c d))
                (IF (|| (== c 248) (== c 64))
                  ((SET d (- 0 d)))
                  (0))
                (SET x *INPUT_X)
                (SET y *INPUT_Y)
                (INIT dot (make-node (- *INPUT_X 2) (- *INPUT_Y 2)
                  (* w 2) (* w 2) (color c c c)))
                (draw dot)
                (line-to 0 0))
              (0))))

        (INIT FRAME_BUFFER 0)
        (INIT ROW_SIZE 1280)
        (INIT COL_SIZE 800)

        (FUNC line-to (x-end y-end)
          (INIT i y)
          (INIT j x)
          (WHILE (!= i y-end)
            (put-pixel j i (color 64 32 32))
            (IF (< (abs (- x-end x)) (abs (- y-end y)))
              ((IF (< i y-end)
                  ((SET i (+ i 1)))
                  ((SET i (- i 1))))
                (SET j (+ x (/ 
                  (* (- i y) (- x-end x))
                  (- y-end y)))))
              ((IF (< j x-end)
                  ((SET j (+ j 1)))
                  ((SET j (- j 1))))
                (SET i (+ y (/ 
                  (* (- j x) (- y-end y))
                  (- x-end x))))))))

        (FUNC draw (node)
          (INIT i (get-field node @top))
          (INIT bottom (+ i (get-field node @height)))
          (WHILE (< i bottom) 
            (INIT j (get-field node @left))
            (INIT right (+ j (get-field node @width)))
            (WHILE (< j right)
              (put-pixel j i (get-field node @color))
              (SET j (+ j 1)))
            (SET i (+ i 1))))
        
        (FUNC put-pixel (x y c)
          (INIT offset (+ (* y ROW_SIZE) x))
          (write FRAME_BUFFER offset c))
        
        (FUNC make-node (x y w h c)
          (INIT p (alloc 5))
          (set-field p @left x)
          (set-field p @top y)
          (set-field p @height h)
          (set-field p @width w)
          (set-field p @color c)
          p)

        (INIT CONSOLE 0x7ffffe)
        (FUNC log (x)
          (SET *CONSOLE x))
        
        (FUNC get-field (node k)
          (read node (offset k)))

        (FUNC set-field (node k v)
          (write node (offset k) v))

        (FUNC offset (k) 
          (IF (== k @left) (0)
            ((IF (== k @top) (1)
              ((IF (== k @width) (2)
                ((IF (== k @height) (3)
                  ((IF (== k @color) (4)
                    ((log 0xffffffff))))))))))))
              
        (INIT free 0x00811000)
        (FUNC alloc (size)
          (INIT res free)
          (SET free (+ free size))
          res)
        
        (FUNC read (base offset)
          (SET base (+ base offset))
          *base)

        (FUNC write (base offset value)
          (SET base (+ base offset))
          (SET *base value))
        
        (FUNC color (r g b)
          (| (| (<< r 16) (<< g 8)) b))
        
        (FUNC abs (n)
          (IF (< n 0) ((- 0 n)) (n)))
      `).bin
    );
  </script>
</body>
