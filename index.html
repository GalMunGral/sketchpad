<!DOCTYPE html>
<body style="background: white; margin: 0">
  <canvas
    width="1280"
    height="800"
    style="
      display: block;
      margin: auto;
      height: min(calc(100vw * 800 / 1280), 100vh);
      width: min(calc(100vh * 1280 / 800), 100vw);
      background: black;
    "
  ></canvas>
</body>
<script type="module">
  import { compile } from "./Compiler.js";
  import { run } from "./CPU.js";

  const out = compile(`
    (INIT HAS_INPUT 0x7ffff0)
    (INIT INPUT_X 0x7ffff1)
    (INIT INPUT_Y 0x7ffff2)

    (FUNC main ()
      (INIT c 64)
      (INIT d 1)
      (INIT w 4)
      (WHILE 1
        (IF *HAS_INPUT 
          ((INIT x *INPUT_X)
            (INIT y *INPUT_Y)
            (SET c (+ c d))
            (IF (|| (== c 255) (== c 64))
              ((SET d (- 0 d))) (0))
            (draw (- x w) (- y w) (* w 2) (* w 2) c c c))
          (0))))
    (FUNC log (x)
      (SET *CONSOLE x))

    (INIT CONSOLE 0x7ffffe)
    (INIT FRAME_BUFFER 0)
    (INIT ROW_SIZE 1280)
    (INIT COL_SIZE 800)

    (FUNC draw (x y w h r g b)
      (INIT color (| (| (<< r 16) (<< g 8)) b))
      (INIT i y)
      (WHILE (< i (+ y h)) 
        (INIT j x)
        (WHILE (< j (+ x w))
          (INIT offset (+ (* i ROW_SIZE) j))
          (memset FRAME_BUFFER offset color)
          (SET j (+ j 1)))
        (SET i (+ i 1))))
          
    (FUNC memset (base offset value)
      (SET base (+ base offset))
      (SET *base value))
    
    (INIT free 0x00811000)
    (FUNC alloc (size)
      (INIT res free)
      (SET free (+ free size))
      res)
  `);
  console.log(out);
  run(out.bin);
</script>
